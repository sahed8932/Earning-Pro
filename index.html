<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earning Pro</title>
    
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- === MONETAG ADS SDK === -->
    <script src="https://libtl.com/sdk.js" data-zone="10055912" data-sdk="show_10055912"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-color: #0f0c15;
            --card-bg: #1e1829;
            --primary: #7b40f2;
            --primary-hover: #6a35d4;
            --text-main: #ffffff;
            --text-muted: #8e8ba3;
            --green: #00d29d;
            --gold: #ffc107;
            --red: #ff4757;
            --nav-bg: #15111e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- WELCOME OVERLAY (Gatekeeper) --- */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #18122B 0%, #0f0c15 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }

        .welcome-subtitle {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .feature-box {
            background: var(--card-bg);
            border: 1px solid #332d42;
            width: 100%;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            text-align: left;
        }

        .feature-icon {
            width: 45px;
            height: 45px;
            background: rgba(123, 64, 242, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary);
            margin-right: 15px;
            flex-shrink: 0;
        }

        .feature-text h4 { font-size: 15px; margin-bottom: 3px; }
        .feature-text p { font-size: 12px; color: var(--text-muted); }

        .btn-welcome {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.2s;
        }

        .btn-join {
            background: linear-gradient(90deg, #0088cc, #005f8f);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
        }

        .btn-continue {
            background: linear-gradient(90deg, #7b40f2, #6a35d4);
            color: white;
            box-shadow: 0 4px 15px rgba(123, 64, 242, 0.3);
            opacity: 0.6; /* Initially disabled look */
        }
        
        .btn-continue.enabled { opacity: 1; }

        /* --- Header Section --- */
        .app-header {
            background-color: var(--bg-color);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2a2635;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 18px;
            color: var(--primary);
        }

        .verified-badge { color: #3b82f6; font-size: 14px; margin-left: 5px; }

        /* --- Notice Bar --- */
        .notice-bar {
            background: #272133;
            color: var(--gold);
            font-size: 12px;
            padding: 8px 0;
            white-space: nowrap;
            overflow: hidden;
            border-bottom: 1px solid #332d42;
        }

        .stats-card {
            background-color: var(--card-bg);
            margin: 15px;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            text-align: center;
            border: 1px solid #332d42;
        }

        .stat-item h4 {
            font-size: 10px;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-item span {
            font-weight: bold;
            font-size: 16px;
        }

        .text-green { color: var(--green); }
        .text-purple { color: #a88bf2; }

        /* --- Main Scrollable Area --- */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .container { padding: 0 15px; }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 15px;
            font-weight: 600;
        }

        .btn-main {
            background-color: var(--primary);
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(123, 64, 242, 0.3);
            transition: 0.2s;
        }

        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { background-color: #4a4a4a; cursor: not-allowed; box-shadow: none; }

        /* --- Tabs Logic --- */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- TASK TAB Styles --- */
        .ad-type-tabs {
            display: flex;
            gap: 20px;
            border-bottom: 1px solid #332d42;
            margin-bottom: 15px;
        }

        .ad-tab {
            padding: 10px 0;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            position: relative;
        }

        .ad-tab.active {
            color: white;
            font-weight: 600;
        }

        .ad-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }

        .ad-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #332d42;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .ad-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .coin-badge {
            background-color: #2a2438;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .progress-section {
            background-color: #272133;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 8px;
            background-color: #383147;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #6a4cd9;
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* --- Dynamic Task List Styles --- */
        .task-list-item {
            background-color: var(--card-bg);
            padding: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            border: 1px solid #332d42;
        }
        .task-icon {
            width: 35px; height: 35px; background: #2a2438; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: var(--primary);
        }
        .task-info { flex: 1; margin-left: 10px; }
        .task-title { font-size: 13px; font-weight: 600; }
        .task-reward { font-size: 11px; color: var(--green); }
        .btn-claim {
            background: var(--primary); color: white; border: none;
            padding: 6px 14px; border-radius: 20px; font-size: 11px; cursor: pointer;
        }
        .btn-claim.completed { 
            background: #333; 
            cursor: default; 
            color: #888;
        }

        /* --- CARDS TAB Styles --- */
        .scratch-area {
            position: relative;
            width: 250px;
            height: 150px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(123, 64, 242, 0.2);
            border: 2px solid #332d42;
            background: #2a2438;
        }

        .scratch-prize {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .scratch-canvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 2;
            cursor: pointer;
            touch-action: none;
        }

        .card-info-box {
            background: #272133;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-muted);
            border-left: 3px solid var(--primary);
        }

        /* --- INVITE TAB Styles --- */
        .invite-box {
            background-color: #272133;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            border: 1px solid #383147;
        }

        .invite-link {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 12px;
            outline: none;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .copy-btn {
            background-color: var(--primary);
            width: 30px;
            height: 30px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            cursor: pointer;
        }

        .join-channel-btn {
            background-color: #0088cc;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            display: block;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            color: var(--text-muted);
            text-align: center;
        }
        
        .duck-emoji { font-size: 80px; margin-bottom: 10px; }

        /* --- WITHDRAW TAB Styles --- */
        .form-group { margin-bottom: 15px; }

        .form-label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            background-color: #272133;
            border: 1px solid #383147;
            padding: 14px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--nav-bg);
            border-top: 1px solid #2a2635;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 200;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            font-size: 10px;
            gap: 5px;
            cursor: pointer;
            width: 25%;
        }

        .nav-item i { font-size: 18px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { color: var(--primary); }

    </style>
</head>
<body>

    <!-- === WELCOME / GATEKEEPER SCREEN === -->
    <div class="welcome-overlay" id="welcomeScreen">
        <h1 class="welcome-title">Welcome, <span id="welcomeName">User</span>!</h1>
        <p class="welcome-subtitle">
            Join our bot and earn scratch cards for referring users. 
            Scratch to win real cash and withdraw anytime!
        </p>

        <div class="feature-box">
            <div class="feature-icon"><i class="fa-solid fa-gift"></i></div>
            <div class="feature-text">
                <h4>Instant Rewards</h4>
                <p>Get scratch cards for every task</p>
            </div>
        </div>

        <div class="feature-box">
            <div class="feature-icon"><i class="fa-solid fa-users"></i></div>
            <div class="feature-text">
                <h4>Referral Program</h4>
                <p>Earn more by inviting friends</p>
            </div>
        </div>

        <div class="feature-box">
            <div class="feature-icon"><i class="fa-solid fa-wallet"></i></div>
            <div class="feature-text">
                <h4>Instant Withdrawals</h4>
                <p>Get your cash anytime</p>
            </div>
        </div>

        <button class="btn-welcome btn-join" onclick="openChannel()">
            Join Channel to Continue <i class="fa-solid fa-arrow-right"></i>
        </button>

        <button class="btn-welcome btn-continue" id="btnContinue" onclick="checkAndContinue()">
            Continue <i class="fa-solid fa-arrow-right"></i>
        </button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <i class="fa-solid fa-coins"></i>
            <span>Earning Pro <i class="fa-solid fa-circle-check verified-badge"></i></span>
        </div>
        <div>
            <i class="fa-solid fa-bell"></i>
        </div>
    </header>

    <!-- LIVE NOTICE BAR -->
    <div class="notice-bar">
        <marquee id="liveNotice">Welcome to Earning Pro! Start earning today...</marquee>
    </div>

    <!-- User Stats -->
    <div class="stats-card">
        <div class="stat-item">
            <h4>ID</h4>
            <span id="displayUserId">...</span>
        </div>
        <div class="stat-item">
            <h4>BALANCE</h4>
            <span class="text-green"><span id="userBalance">0.00</span> BDT</span>
        </div>
        <div class="stat-item">
            <h4>CARDS</h4>
            <span class="text-purple"><i class="fa-solid fa-ticket"></i> <span id="userCards">0</span></span>
        </div>
    </div>

    <!-- Scrollable Content -->
    <div class="content-area">
        
        <!-- === TASK TAB === -->
        <div id="tab-task" class="tab-content active container">
            
            <div class="section-title">
                <i class="fa-solid fa-rectangle-ad"></i> Watch Ads & Earn
            </div>

            <div class="ad-type-tabs">
                <div class="ad-tab active">Fast Ads ‚ö°</div>
                <div class="ad-tab">Mega Ads üî•</div>
            </div>

            <!-- AD CARD -->
            <div class="ad-card">
                <div class="ad-header">
                    <div><strong>Daily Ads ‚ö°</strong></div>
                    <div class="coin-badge"><i class="fa-solid fa-coins"></i> <span id="displayPerAd">0.50</span> BDT</div>
                </div>

                <div class="progress-section">
                    <div class="progress-label">
                        <span>Daily Progress</span>
                        <span style="color:#a88bf2;"><span id="adsWatchedCount">0</span>/<span id="dailyLimitDisp">6</span></span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="adProgressBar" style="width: 0%"></div></div>
                    <div class="sub-text">Reset every 12 hours</div>
                </div>

                <div id="countdownTimer" style="text-align:center; color:#ff4757; font-size:13px; margin-bottom:10px; display:none;">
                    Wait <span id="timerSec">45</span>s for next ad
                </div>

                <button class="btn-main" id="watchAdBtn" onclick="tryWatchAd()">
                    <i class="fa-solid fa-play-circle"></i> Watch Ad Now
                </button>
            </div>

            <!-- DYNAMIC TASK LIST -->
            <div class="section-title">Extra Tasks</div>
            <div id="dynamicTaskList">
                <div class="empty-state" style="padding: 20px 0;">
                    <p style="font-size: 12px;">Loading tasks...</p>
                </div>
            </div>

        </div>

        <!-- === CARDS TAB === -->
        <div id="tab-cards" class="tab-content container">
            <div class="section-title">Scratch & Win</div>
            <hr style="border: 0; border-top: 1px solid #332d42; margin-bottom: 20px;">
            
            <div style="text-align:center; color:white; margin-bottom:10px;">
                Available Cards: <span style="color:var(--gold); font-weight:bold;" id="cardsAvailable">0</span>
            </div>

            <!-- Real Scratch Area -->
            <div class="scratch-area" id="scratchPadContainer">
                <!-- Prize hidden underneath -->
                <div class="scratch-prize">
                    <i class="fa-solid fa-crown" style="font-size: 30px; color: #ffc107; margin-bottom: 10px;"></i>
                    <span id="scratchResult" style="font-size: 20px; font-weight: bold; color: white;">???</span>
                </div>
                <!-- Canvas Cover -->
                <canvas id="scratchCanvas" class="scratch-canvas" width="250" height="150"></canvas>
            </div>

            <div class="card-info-box">
                <strong>‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶¨‡ßá‡¶®?</strong><br>
                ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶° ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶ø ‡ßß‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ö ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§<br><br>
                <strong>‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?</strong><br>
                ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶Ü‡¶ô‡ßÅ‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ò‡¶∑‡ßá (Swipe ‡¶ï‡¶∞‡ßá) ‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶∞‡¶æ‡¶®‡•§ ‡¶≠‡¶ø‡¶§‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶® ‡¶Ø‡¶æ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá‡•§
            </div>
            
            <button class="btn-main" onclick="resetScratchPad()" style="margin-top:20px; background:#2a2438; border:1px solid #383147;">
                <i class="fa-solid fa-rotate-right"></i> Try Another Card
            </button>
        </div>

        <!-- === INVITE TAB === -->
        <div id="tab-invite" class="tab-content container">
            <a href="https://t.me/shbtechbd" target="_blank" class="join-channel-btn">
                <i class="fa-brands fa-telegram"></i> Join Our Channel
            </a>

            <div class="section-title">Your Referral Link</div>
            
            <div class="invite-box">
                <input type="text" class="invite-link" id="refLink" value="Loading..." readonly>
                <button class="copy-btn" onclick="copyRefLink()"><i class="fa-regular fa-copy"></i></button>
            </div>

            <div class="section-title">My Referrals</div>
            <div style="text-align:center; color:#00d29d; font-size:14px; margin-bottom: 10px;">Total Referrals: <span id="refCount">0</span></div>

            <div class="empty-state">
                <div class="duck-emoji">üê§</div>
                <p>Share your link to start earning!</p>
                <p style="font-size:12px; color:#a88bf2;">1 Referral = 1 Scratch Card</p>
            </div>
        </div>

        <!-- === WITHDRAW TAB === -->
        <div id="tab-withdraw" class="tab-content container">
            <div class="section-title">Withdraw Funds</div>
            <hr style="border: 0; border-top: 1px solid #332d42; margin-bottom: 15px;">
            
            <p style="font-size:12px; color:#8e8ba3; margin-bottom:15px; background: #2a2438; padding: 10px; border-radius: 8px;">
                <i class="fa-solid fa-circle-info"></i> Minimum: 25 BDT, Maximum: 35 BDT
            </p>

            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" class="form-input" id="withdrawAmount" placeholder="Enter amount (25-35)">
            </div>

            <div class="form-group">
                <label class="form-label">Withdrawal Method</label>
                <select class="form-select" id="withdrawMethod">
                    <option value="">Select a method</option>
                    <option value="bkash">Bkash</option>
                    <option value="nagad">Nagad</option>
                    <option value="binance">Binance (USDT)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Account Number / ID</label>
                <input type="text" class="form-input" id="withdrawNumber" placeholder="Number or Binance Pay ID">
            </div>

            <button class="btn-main" id="withdrawBtn" onclick="attemptWithdraw()">Withdraw</button>

            <div class="section-title" style="margin-top: 30px;">Withdrawal History</div>
            <hr style="border: 0; border-top: 1px solid #332d42; margin-bottom: 15px;">

            <div id="withdrawHistoryList">
                 <div class="empty-state">
                    <div class="duck-emoji" style="filter: grayscale(0.2);">ü§î</div>
                    <p>No withdrawal history yet.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('task', this)">
            <i class="fa-solid fa-list-check"></i>
            <span>TASK</span>
        </div>
        <div class="nav-item" onclick="switchTab('cards', this)">
            <i class="fa-solid fa-credit-card"></i>
            <span>CARDS</span>
        </div>
        <div class="nav-item" onclick="switchTab('invite', this)">
            <i class="fa-solid fa-user-plus"></i>
            <span>INVITE</span>
        </div>
        <div class="nav-item" onclick="switchTab('withdraw', this)">
            <i class="fa-solid fa-money-bill-transfer"></i>
            <span>WITHDRAW</span>
        </div>
    </nav>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBkwmmvizglg1i5MymmRWiA2KPhAHVO5Sc",
            authDomain: "earningpro-2a4b8.firebaseapp.com",
            databaseURL: "https://earningpro-2a4b8-default-rtdb.firebaseio.com",
            projectId: "earningpro-2a4b8",
            storageBucket: "earningpro-2a4b8.firebasestorage.app",
            messagingSenderId: "366145424614",
            appId: "1:366145424614:web:2cc7a2a40648519a97ff27"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // ============================================
        // TELEGRAM & USER SETUP
        // ============================================
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const rawUser = tg.initDataUnsafe?.user;
        const userId = rawUser ? rawUser.id.toString() : 'TEST_USER_999';
        const userName = rawUser ? rawUser.first_name : 'Guest';
        const startParam = tg.initDataUnsafe?.start_param; 

        const BOT_USERNAME = "Task_To_Work_bot"; 
        const CHANNEL_LINK = "https://t.me/shbtechbd";

        // Global Variables
        let userProfile = {};
        let dbRef = db.ref('users/' + userId);
        
        let adminAdLink = null;
        let dailyLimit = 6;
        let perAdReward = 0.50;
        let currentTasks = {};
        
        // Gatekeeper State
        let hasJoinedChannel = false;

        // ============================================
        // INITIALIZATION
        // ============================================
        window.onload = function() {
            document.getElementById('displayUserId').innerText = userId;
            document.getElementById('welcomeName').innerText = userName;
            document.getElementById('refLink').value = `https://t.me/${BOT_USERNAME}?startapp=${userId}`;

            // Initialize Scratch Canvas
            initScratchCard();

            // 1. Fetch User Data
            dbRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    createUser(startParam);
                } else {
                    initRealtimeListener();
                }
            });

            // 2. Fetch Admin Settings
            db.ref('settings').on('value', snap => {
                const settings = snap.val();
                if(settings) {
                    if(settings.notice) document.getElementById('liveNotice').innerText = settings.notice;
                    if(settings.adLink) adminAdLink = settings.adLink;
                    if(settings.dailyLimit) dailyLimit = parseInt(settings.dailyLimit);
                    if(settings.perAdReward) perAdReward = parseFloat(settings.perAdReward);
                    
                    document.getElementById('displayPerAd').innerText = perAdReward.toFixed(2);
                    document.getElementById('dailyLimitDisp').innerText = dailyLimit;
                }
            });

            // 3. Fetch Dynamic Tasks
            db.ref('tasks').on('value', snap => {
                const tasks = snap.val();
                currentTasks = tasks;
                renderDynamicTasks(tasks);
            });
        };

        // --- WELCOME SCREEN LOGIC ---
        function openChannel() {
            window.open(CHANNEL_LINK, '_blank');
            hasJoinedChannel = true;
            document.getElementById('btnContinue').classList.add('enabled');
        }

        function checkAndContinue() {
            if (!hasJoinedChannel) {
                // Telegram doesn't allow checking 'join' status client-side easily without bot api.
                // We force the user flow: Must click Join first.
                alert("Please join our channel first to continue!");
                return;
            }
            // Hide Overlay
            document.getElementById('welcomeScreen').style.display = 'none';
        }

        function createUser(referrerId) {
            const initialData = {
                id: userId,
                name: userName,
                balance: 0.00,
                status: 'active', // Everyone is active now
                cards: 0,
                referrals: 0,
                ad_cycle: { count: 0, last_reset: Date.now(), last_watch: 0 },
                completed_tasks: {}
            };

            if (referrerId && referrerId !== userId) {
                db.ref('users/' + referrerId).once('value').then(snap => {
                    if (snap.exists()) {
                        const refData = snap.val();
                        db.ref('users/' + referrerId).update({
                            referrals: (refData.referrals || 0) + 1,
                            cards: (refData.cards || 0) + 1
                        });
                        initialData.referred_by = referrerId;
                    }
                    dbRef.set(initialData).then(() => initRealtimeListener());
                });
            } else {
                dbRef.set(initialData).then(() => initRealtimeListener());
            }
        }

        function initRealtimeListener() {
            dbRef.on('value', (snapshot) => {
                if(snapshot.exists()) {
                    userProfile = snapshot.val();
                    updateUI();
                }
            });
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateUI() {
            const bal = parseFloat(userProfile.balance || 0);
            document.getElementById('userBalance').innerText = bal.toFixed(2);
            
            document.getElementById('userCards').innerText = userProfile.cards || 0;
            document.getElementById('cardsAvailable').innerText = userProfile.cards || 0;
            document.getElementById('refCount').innerText = userProfile.referrals || 0;

            const cycle = userProfile.ad_cycle || { count: 0, last_reset: 0 };
            
            checkAdResetCycle(cycle);
            
            document.getElementById('adsWatchedCount').innerText = cycle.count || 0;
            const progressPct = ((cycle.count || 0) / dailyLimit) * 100;
            document.getElementById('adProgressBar').style.width = progressPct + "%";
            
            if(currentTasks) renderDynamicTasks(currentTasks);
        }

        // ============================================
        // DYNAMIC TASKS LOGIC
        // ============================================
        function renderDynamicTasks(tasks) {
            const container = document.getElementById('dynamicTaskList');
            container.innerHTML = '';

            if(!tasks) {
                container.innerHTML = '<div class="empty-state"><p style="font-size: 12px;">No extra tasks available</p></div>';
                return;
            }

            const completed = userProfile.completed_tasks || {};

            Object.values(tasks).forEach(task => {
                const isDone = completed[task.id] === true;
                
                const btnClass = isDone ? 'btn-claim completed' : 'btn-claim';
                const btnText = isDone ? 'Completed' : 'Claim';
                const onClick = isDone ? '' : `onclick="doTask('${task.id}', '${task.link}', ${task.reward})"`;

                const html = `
                <div class="task-list-item">
                    <div class="task-icon"><i class="${task.icon}"></i></div>
                    <div class="task-info">
                        <div class="task-title">${task.title}</div>
                        <div class="task-reward">+${task.reward} BDT</div>
                    </div>
                    <button class="${btnClass}" ${onClick}>${btnText}</button>
                </div>
                `;
                container.innerHTML += html;
            });
        }

        function doTask(taskId, link, reward) {
            window.open(link, '_blank');
            setTimeout(() => {
                const confirmClaim = confirm("Did you join/complete the task?");
                if(confirmClaim) {
                    const updates = {};
                    const newBal = (parseFloat(userProfile.balance) || 0) + parseFloat(reward);
                    updates[`users/${userId}/balance`] = newBal;
                    updates[`users/${userId}/completed_tasks/${taskId}`] = true;
                    
                    db.ref().update(updates).then(() => {
                        alert(`Reward Added: ${reward} BDT`);
                    });
                }
            }, 5000); 
        }

        // ============================================
        // WATCH ADS LOGIC
        // ============================================
        function checkAdResetCycle(cycle) {
            const lastReset = cycle.last_reset || 0;
            if (Date.now() - lastReset > 43200000) {
                dbRef.child('ad_cycle').update({ count: 0, last_reset: Date.now() });
            }
        }

        function tryWatchAd() {
            const cycle = userProfile.ad_cycle || { count: 0, last_watch: 0, last_reset: 0 };
            checkAdResetCycle(cycle);
            
            if (cycle.count >= dailyLimit) {
                alert(`Daily limit (${dailyLimit} Ads) reached! Resets in 12h.`);
                return;
            }
            
            if (Date.now() - cycle.last_watch < 45000) {
                alert("Please wait for cooldown!");
                return;
            }

            if (adminAdLink && adminAdLink.length > 5) {
                window.open(adminAdLink, '_blank');
                setTimeout(() => { giveAdReward(); }, 8000); 
            } else {
                if (typeof show_10055912 === 'function') {
                    show_10055912().then(() => { giveAdReward(); })
                    .catch(e => { setTimeout(() => { giveAdReward(); }, 5000); });
                } else {
                    alert("Ad Loading... Please wait.");
                    setTimeout(() => { giveAdReward(); }, 5000);
                }
            }
        }

        function giveAdReward() {
            const currentBal = parseFloat(userProfile.balance || 0);
            const rewardAmount = parseFloat(perAdReward);
            const newBalance = parseFloat((currentBal + rewardAmount).toFixed(2));
            const currentCount = userProfile.ad_cycle ? userProfile.ad_cycle.count : 0;
            
            dbRef.update({
                balance: newBalance,
                'ad_cycle/count': currentCount + 1,
                'ad_cycle/last_watch': Date.now()
            });

            startTimerUI(45);
        }

        function startTimerUI(seconds) {
            const timerBox = document.getElementById('countdownTimer');
            const timerSpan = document.getElementById('timerSec');
            const btn = document.getElementById('watchAdBtn');

            timerBox.style.display = 'block';
            btn.disabled = true;

            let left = seconds;
            timerSpan.innerText = left;

            const interval = setInterval(() => {
                left--;
                timerSpan.innerText = left;
                if (left <= 0) {
                    clearInterval(interval);
                    timerBox.style.display = 'none';
                    btn.disabled = false;
                }
            }, 1000);
        }

        // ============================================
        // REAL SCRATCH CARD LOGIC (CANVAS)
        // ============================================
        let isScratching = false;
        let isCardRevealed = false;
        let scratchCtx;
        
        function initScratchCard() {
            const canvas = document.getElementById('scratchCanvas');
            scratchCtx = canvas.getContext('2d');
            
            // Reset state
            isCardRevealed = false;
            
            // Draw gray overlay
            scratchCtx.globalCompositeOperation = 'source-over';
            scratchCtx.fillStyle = '#b3b3b3'; 
            scratchCtx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add text "SCRATCH HERE"
            scratchCtx.fillStyle = '#333';
            scratchCtx.font = '20px Arial';
            scratchCtx.textAlign = 'center';
            scratchCtx.fillText("SCRATCH ME", canvas.width/2, canvas.height/2);

            // Add Event Listeners
            canvas.addEventListener('mousedown', startScratch);
            canvas.addEventListener('touchstart', startScratch);
            canvas.addEventListener('mousemove', scratch);
            canvas.addEventListener('touchmove', scratch);
            canvas.addEventListener('mouseup', endScratch);
            canvas.addEventListener('touchend', endScratch);
        }

        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            const clientX = evt.clientX || evt.touches[0].clientX;
            const clientY = evt.clientY || evt.touches[0].clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startScratch(e) {
            e.preventDefault();
            if(isCardRevealed) return;

            // Check if user has cards
            if ((userProfile.cards || 0) <= 0) {
                alert("No cards available! Refer friends to earn cards.");
                return;
            }
            isScratching = true;
        }

        function scratch(e) {
            if (!isScratching || isCardRevealed) return;
            e.preventDefault();

            const canvas = document.getElementById('scratchCanvas');
            const pos = getMousePos(canvas, e);

            scratchCtx.globalCompositeOperation = 'destination-out';
            scratchCtx.beginPath();
            scratchCtx.arc(pos.x, pos.y, 15, 0, Math.PI * 2);
            scratchCtx.fill();

            checkScratchCompletion(canvas);
        }

        function endScratch() {
            isScratching = false;
        }

        function checkScratchCompletion(canvas) {
            const imageData = scratchCtx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            let transparentPixels = 0;

            for (let i = 0; i < pixels.length; i += 4) {
                if (pixels[i + 3] < 128) {
                    transparentPixels++;
                }
            }

            const percentage = (transparentPixels / (pixels.length / 4)) * 100;

            if (percentage > 40 && !isCardRevealed) {
                isCardRevealed = true;
                completeScratch();
            }
        }

        function completeScratch() {
            const rewards = [0.20, 0.50, 1.00, 2.00];
            const prize = rewards[Math.floor(Math.random() * rewards.length)];
            
            document.getElementById('scratchResult').innerText = `+${prize} BDT`;
            
            // Clear entire canvas
            scratchCtx.clearRect(0, 0, 300, 150);

            // Update Database
            const currentBal = parseFloat(userProfile.balance || 0);
            const newBal = parseFloat((currentBal + prize).toFixed(2));

            dbRef.update({
                cards: (userProfile.cards || 0) - 1,
                balance: newBal
            }).then(() => {
                alert(`Congratulation! You won ${prize} BDT`);
            });
        }

        function resetScratchPad() {
            if ((userProfile.cards || 0) > 0) {
                initScratchCard();
                document.getElementById('scratchResult').innerText = "???";
            } else {
                alert("You don't have enough cards!");
            }
        }

        // ============================================
        // WITHDRAW LOGIC
        // ============================================
        function attemptWithdraw() {
            const btn = document.getElementById('withdrawBtn');
            btn.disabled = true;
            btn.innerText = "Processing...";

            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const method = document.getElementById('withdrawMethod').value;
            const number = document.getElementById('withdrawNumber').value;
            const currentBal = parseFloat(userProfile.balance || 0);

            if (!method || !number || amount < 25 || amount > 35) {
                alert("Invalid details or Amount (25-35)");
                btn.disabled = false;
                btn.innerText = "Withdraw";
                return;
            }
            if (currentBal < amount) {
                alert("Insufficient balance.");
                btn.disabled = false;
                btn.innerText = "Withdraw";
                return;
            }

            const reqId = db.ref('withdrawals').push().key;
            const updates = {};
            const newBal = parseFloat((currentBal - amount).toFixed(2));
            
            updates['users/' + userId + '/balance'] = newBal;
            updates['withdrawals/' + reqId] = {
                userId: userId,
                userName: userProfile.name || 'User',
                amount: amount,
                method: method,
                number: number,
                status: 'pending', 
                time: Date.now()
            };

            db.ref().update(updates).then(() => {
                alert("Withdrawal submitted!");
                document.getElementById('withdrawAmount').value = '';
                btn.disabled = false;
                btn.innerText = "Withdraw";
            }).catch(error => {
                alert("Error submitting withdrawal. Try again.");
                btn.disabled = false;
                btn.innerText = "Withdraw";
            });
        }

        // ============================================
        // UTILS
        // ============================================
        function copyRefLink() {
            const copyText = document.getElementById("refLink");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value);
            alert("Referral Link Copied!");
        }

        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            element.classList.add('active');
        }
    </script>
</body>
</html>
